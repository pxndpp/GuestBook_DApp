<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guestbook DApp</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playpen+Sans+Thai:wght@100..800&display=swap" rel="stylesheet">
    <style>
        body, .btn-primary, .btn-primary:disabled, .fab-btn, .btn-secondary{
            font-family: "Playpen Sans Thai", cursive;
            font-optical-sizing: auto;
            font-weight: 100;
            font-style: normal;
        } /*‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô font ‡πÅ‡∏ö‡∏ö‡∏£‡∏ß‡∏°‡πÜ*/


        body {max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f4f4f9; }
        .container {background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 10px rgba(0, 0, 0, 0.2); min-height: 30%; }
        
        /* ‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏Å (‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°, ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ß‡∏≠‡πÄ‡∏•‡∏ó)*/
        .btn-primary {font-weight: bold; background-color: #ff9900; color: white; border: none; padding: 10px; width: 100%; border-radius: 6px; cursor: pointer;}
        .btn-primary:disabled {font-weight: bold; background-color: #ccc; cursor: not-allowed; }
        
        /* ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏≠‡∏á (‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö) */
        .btn-secondary {font-weight: bold; background-color: #ff2525; color: #ffffff; border: 1px solid #ddd; padding: 10px; width: 100%; border-radius: 6px; cursor: pointer; margin-top: 5px; }
        
        /* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà ‡πÑ‡∏ß‡πâ‡∏¢‡πâ‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤ aka ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πâ‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤*/
        .fab-btn {
            background-color: #037c17; color: white; border: none; padding: 15px 20px;
            border-radius: 50px; cursor: pointer; box-shadow: 0 4px 10px rgba(33, 150, 243, 0.4);
            font-weight: bold; margin-bottom: 20px; width: 100%;
        }

        input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .entry { border-bottom: 1px solid #eee; padding: 15px 0; }
        .name-tag { font-weight: bold; color: #2c3e50; font-size: 1.1em; }
        .wallet-status { text-align: center; font-size: 0.85em; color: #666; margin-bottom: 20px; background: #eee; padding: 5px; border-radius: 4px; }
    </style>
</head>
<body>

    <div class="container" x-data="guestbookApp()">
        
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 10px;"><b>
                üìì Guestbook üìì
                <span style="font-size: 1em; color: #aaa;">
                    ‡∏™‡∏°‡∏∏‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°
                </span>
            </h2>
            <span x-show="currentAccount" style="font-size: 0.8em; color: #aaa;">
                Wallet ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏µ‡πà‡∏à‡πâ‡∏≤
            </span>
            <div x-show="currentAccount" class="wallet-status">
                ü¶ä <span x-text="shortenAddress(currentAccount)"></span>
            </div>
        </div>

        <hr style="margin-bottom: 20px;">

        <div x-show="!currentAccount" style="text-align: center; padding: 40px 0;">
            <p>üôèüèª ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô üôèüèª</p>
            <button class="btn-primary" @click="connectWallet">[ Connect MetaMask ]</button>
        </div>

        <div x-show="currentAccount">

            <div x-show="view === 'home'"  x-transition:enter.duration.400ms>
                <span style="padding-left: 15px"><b>‡∏≠‡∏¢‡∏≤‡∏Å‡∏ù‡∏≤‡∏Å‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏ß‡πâ‡∏ö‡πâ‡∏≤‡∏á‡πÑ‡∏´‡∏°?</span> 
                <br>
                <button class="fab-btn" @click="view = 'write'">
                    ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏•‡∏á‡∏™‡∏°‡∏∏‡∏î ‚úèÔ∏è
                </button>

                <h3 style="margin-top: 0;">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏™‡∏°‡∏∏‡∏î (<span x-text="Guest.length"></span>)</h3>
                <hr>
                <div x-show="Guest.length === 0" style="text-align: center; color: #888; padding: 20px;">
                    ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...
                </div>

                <template x-for="entry in Guest" :key="entry.timestamp">
                    <div class="entry">
                        <div>
                            <span class="name-tag" x-text="entry.w_name"></span> 
                            <span style="font-size: 0.8em; color: #aaa; margin-left: 5px;">
                                (<span x-text="shortenAddress(entry.writer)"></span>)
                            </span>
                        </div>
                        <div x-text="entry.message" style="margin: 8px 0; color: #444;"></div>
                        <div style="font-size: 0.75em; color: #999;">
                            üïí <span x-text="formatDate(entry.timestamp)"></span>
                        </div>
                    </div>
                </template>
            </div>

            <div 
                x-show="view === 'write'" x-transition:enter.duration.400ms>
                <h3>‚úíÔ∏è‚úèÔ∏è</h3>
                
                <label>‡∏ä‡∏∑‡πà‡∏≠ / AKA (also know as) :</label>
                <input type="text" x-model="name" placeholder="‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏≤‡∏à‡∏î‡∏à‡∏≥‡∏Ñ‡∏∏‡∏ì‡∏ß‡πà‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏á..." :disabled="isLoading">
                
                <label>‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡∏ö‡∏≠‡∏Å / ‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô :</label>
                <input type="text" x-model="message" placeholder="‡∏≠‡∏¢‡∏≤‡∏Å‡∏ö‡∏≠‡∏Å‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡∏±‡∏ö‡πÄ‡∏£‡∏≤‡∏ö‡πâ‡∏≤‡∏á..." :disabled="isLoading">
                
                <p x-show="errorMessage" x-text="errorMessage" style="color: red; font-size: 0.9em;"></p>

                <button class="btn-primary" @click="signGuestbook" :disabled="isLoading || !message || !name">
                    <span x-show="isLoading">
                        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...
                    </span>

                    <span x-show="!isLoading">
                        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                    </span>
                </button>

                <button class="btn-secondary" @click="view = 'home'" :disabled="isLoading">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å / ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
                </button>
            </div>

        </div>
    </div>

    <script>
        function guestbookApp() {
            return {
                //CONFIG
                contractAddress: "0x2C5348Eb3481d608857c9e7482D9E9a434DD1bdB",
                contractABI: [
                    {
                        "anonymous": false,
                        "inputs": [
                            {
                                "indexed": true,
                                "internalType": "address",
                                "name": "writer",
                                "type": "address"
                            },
                            {
                                "indexed": false,
                                "internalType": "string",
                                "name": "w_name",
                                "type": "string"
                            },
                            {
                                "indexed": false,
                                "internalType": "string",
                                "name": "message",
                                "type": "string"
                            },
                            {
                                "indexed": false,
                                "internalType": "uint256",
                                "name": "timestamp",
                                "type": "uint256"
                            }
                        ],
                        "name": "New_Msg",
                        "type": "event"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "string",
                                "name": "_w_name",
                                "type": "string"
                            },
                            {
                                "internalType": "string",
                                "name": "_message",
                                "type": "string"
                            }
                        ],
                        "name": "Write_Msg",
                        "outputs": [],
                        "stateMutability": "nonpayable",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "address",
                                "name": "",
                                "type": "address"
                            }
                        ],
                        "name": "checkspam",
                        "outputs": [
                            {
                                "internalType": "uint256",
                                "name": "",
                                "type": "uint256"
                            }
                        ],
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "inputs": [],
                        "name": "getAll_Msg",
                        "outputs": [
                            {
                                "components": [
                                    {
                                        "internalType": "address",
                                        "name": "writer",
                                        "type": "address"
                                    },
                                    {
                                        "internalType": "string",
                                        "name": "w_name",
                                        "type": "string"
                                    },
                                    {
                                        "internalType": "string",
                                        "name": "message",
                                        "type": "string"
                                    },
                                    {
                                        "internalType": "uint256",
                                        "name": "timestamp",
                                        "type": "uint256"
                                    }
                                ],
                                "internalType": "struct Guestbook.Guest[]",
                                "name": "",
                                "type": "tuple[]"
                            }
                        ],
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "inputs": [],
                        "name": "getTotal_Msg",
                        "outputs": [
                            {
                                "internalType": "uint256",
                                "name": "",
                                "type": "uint256"
                            }
                        ],
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "inputs": [
                            {
                                "internalType": "uint256",
                                "name": "",
                                "type": "uint256"
                            }
                        ],
                        "name": "messages",
                        "outputs": [
                            {
                                "internalType": "address",
                                "name": "writer",
                                "type": "address"
                            },
                            {
                                "internalType": "string",
                                "name": "w_name",
                                "type": "string"
                            },
                            {
                                "internalType": "string",
                                "name": "message",
                                "type": "string"
                            },
                            {
                                "internalType": "uint256",
                                "name": "timestamp",
                                "type": "uint256"
                            }
                        ],
                        "stateMutability": "view",
                        "type": "function"
                    }
                ],

                //STATE
                view: 'home',
                currentAccount: null,
                name: '',
                message: '',
                Guest: [],
                isLoading: false,
                errorMessage: '',

                //INIT
                async init() {
                    if (window.ethereum) {
                        const provider = new ethers.BrowserProvider(window.ethereum);
                        const accounts = await provider.listAccounts();
                        if (accounts.length > 0) {
                            this.currentAccount = accounts[0].address;
                            this.fetchEntries();
                        }
                    }
                },

                //CONNECT
                async connectWallet() {
                    if (!window.ethereum) return alert("Install MetaMask!");
                    try {
                        const provider = new ethers.BrowserProvider(window.ethereum);
                        const accounts = await provider.send("eth_requestAccounts", []);
                        this.currentAccount = accounts[0];
                        this.fetchEntries();
                    } catch (e) { console.error(e); }
                },

                //READ ALL MSG
                async fetchEntries() {
                    if (!this.contractAddress.startsWith("0x")) return;
                    try {
                        const provider = new ethers.BrowserProvider(window.ethereum);
                        const contract = new ethers.Contract(this.contractAddress, this.contractABI, provider);
                        const rawEntries = await contract.getAll_Msg();
                        this.Guest = Array.from(rawEntries).reverse();
                    } catch (error) { console.error("Fetch Error:", error); }
                },

                //WRITE MSG
                async signGuestbook() {
                    if (!this.message || !this.name) return;
                    
                    this.isLoading = true;
                    this.errorMessage = '';

                    try {
                        const provider = new ethers.BrowserProvider(window.ethereum);
                        const signer = await provider.getSigner();
                        const contract = new ethers.Contract(this.contractAddress, this.contractABI, signer);

                        // ‡∏™‡πà‡∏á Transaction
                        const tx = await contract.Write_Msg(this.name, this.message);
                        console.log("Tx Hash:", tx.hash);
                        
                        // ‡∏£‡∏≠ Confirm
                        await tx.wait(); 
                        
                        // ‡∏ú‡πà‡∏≤‡∏ô
                        this.message = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                        await this.fetchEntries(); // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà

                        //‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
                        this.view = 'home';

                    } catch (error) {
                        console.error("Write Error:", error);
                        if (error.reason && error.reason.includes("wait")) {
                            this.errorMessage = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ";
                        } else {
                            this.errorMessage = error.reason || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î";
                        }
                    } finally {
                        this.isLoading = false;
                    }
                },
                formatDate(timestamp) {
                    return new Date(Number(timestamp) * 1000).toLocaleString('th-TH');
                },
                shortenAddress(address) {
                    return address ? `${address.slice(0, 6)}...${address.slice(-4)}` : '';
                }
            }
        }
    </script>
</body>
</html>